<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Python 分发站 — 专业下载（单文件）</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
  :root{
    /* 色彩与材质变量 */
    --bg: linear-gradient(180deg,#f6f8fb,#fff);
    --panel-bg: rgba(255,255,255,0.55);
    --card-bg: rgba(255,255,255,0.6);
    --muted: #5b6670;
    --accent: #f57c00; /* 默认主题橙色（可切换） */
    --accent-2: #ffb300;
    --glass-opa: 0.12; /* 用于边框/高光的不透明度 */
    --radius:14px;
    --shadow-1: 0 6px 22px rgba(16,24,32,0.08);
    --shadow-2: 0 18px 40px rgba(16,24,32,0.12);
    --mono: 'Roboto Mono', monospace;
    --ui: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    --glass-blur: 18px;
    --glass-sat: 1.15;
    --glass-contrast: 1.05;
    --glass-depth: 0.06;
    --btn-depth: 0.08;
  }

  /* 基础布局 */
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:var(--ui);
    background:var(--bg);
    color:#0b1220;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    transition:background .28s ease,color .28s ease;
  }
  .container{max-width:980px;margin:34px auto;padding:20px}

  /* 透明立体玻璃质感：header & panels */
  header{
    position:relative;
    display:flex;
    align-items:center;
    gap:16px;
    padding:14px;
    border-radius:calc(var(--radius) + 4px);
    background: var(--panel-bg);
    border:1px solid rgba(255,255,255,var(--glass-opa));
    box-shadow: var(--shadow-1), 0 2px 0 rgba(255,255,255,0.4) inset;
    backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-sat)) contrast(var(--glass-contrast));
    -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-sat)) contrast(var(--glass-contrast));
    transition:transform .18s ease, box-shadow .18s ease, background .18s ease;
    overflow:visible;
  }
  /* 顶部立体高光条（伪元素） */
  header::before{
    content:"";
    position:absolute;left:0;right:0;top:0;height:40%;
    border-radius:calc(var(--radius) + 4px) calc(var(--radius) + 4px) 0 0;
    background:linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.06));
    pointer-events:none;
    mix-blend-mode: overlay;
  }
  /* 底部柔和阴影（伪元素） */
  header::after{
    content:"";
    position:absolute;left:8px;right:8px;bottom:-10px;height:18px;
    filter: blur(18px);
    background: radial-gradient(ellipse at center, rgba(12,18,30,0.12), rgba(12,18,30,0));
    opacity:0.95;
    pointer-events:none;
  }

  .logo{
    width:56px;height:56px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:1.4rem;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    box-shadow: 0 6px 18px rgba(0,0,0,0.12), 0 2px 0 rgba(255,255,255,0.12) inset;
    transform: translateZ(0); /* force layer for smoother rendering */
  }
  .title h1{margin:0;font-size:18px}
  .title p{margin:4px 0 0;color:var(--muted);font-size:13px}
  .tools{margin-left:auto;display:flex;gap:10px;align-items:center;position:relative}

  /* 按钮（玻璃且有轻微立体感） */
  .btn{
    display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:10px;
    background: linear-gradient(180deg, rgba(255,255,255,0.84), rgba(255,255,255,0.65));
    border:1px solid rgba(10,14,20,0.06);
    color:#0b1220;font-weight:600;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease, opacity .12s;
    box-shadow: 0 2px 6px rgba(12,18,30,0.06), 0 1px 0 rgba(255,255,255,0.6) inset;
    backdrop-filter: blur(6px);
  }
  .btn:active{transform: translateY(1px)}
  .btn.primary{
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    color:#fff;
    border: 1px solid rgba(0,0,0,0.06);
    box-shadow: 0 14px 32px rgba(0,0,0,var(--btn-depth)), 0 -2px 8px rgba(255,255,255,0.04) inset;
    background-image:
      linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)),
      linear-gradient(180deg, var(--accent), var(--accent-2));
    background-blend-mode: overlay;
  }
  .btn.ghost{background:transparent;border:1px solid rgba(10,14,20,0.06)}

  /* 主题菜单：单一按钮展开下拉，不一次性显示所有色块 */
  .theme-menu{
    position:relative;
  }
  .theme-toggle{
    display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;border:1px solid rgba(10,14,20,0.06);
    background:transparent;color:var(--muted);cursor:pointer;
  }
  .theme-panel{
    position:absolute;right:0;top:calc(100% + 10px);width:260px;padding:10px;border-radius:12px;
    background: rgba(255,255,255,0.56);backdrop-filter: blur(20px) saturate(1.08);
    border:1px solid rgba(255,255,255,0.08);box-shadow:var(--shadow-2);
    display:none;flex-direction:column;gap:10px;z-index:1400;
  }
  .theme-panel.show{display:flex}
  .theme-option{display:flex;align-items:center;gap:10px;cursor:pointer;padding:8px;border-radius:8px}
  .swatch{width:36px;height:28px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);box-shadow:0 4px 12px rgba(0,0,0,0.06)}
  .theme-label{font-weight:600;color:#222;font-size:14px}
  .theme-controls-row{display:flex;gap:8px;align-items:center;justify-content:space-between}

  /* controls inside theme panel */
  .small-note{font-size:12px;color:var(--muted)}
  .glass-switch{display:flex;align-items:center;gap:8px}
  .glass-switch input[type="checkbox"]{transform:scale(1.1);}

  /* 搜索/控件/网格/卡片 */
  .controls{display:flex;gap:10px;align-items:center;margin-top:18px}
  .search{flex:1;display:flex;gap:8px;align-items:center}
  input[type="search"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(10,14,20,0.06);background:rgba(255,255,255,0.7);font-size:14px}
  select{padding:9px;border-radius:10px;border:1px solid rgba(10,14,20,0.06);background:rgba(255,255,255,0.7);font-size:14px}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-top:18px}
  @media(max-width:820px){.grid{grid-template-columns:1fr}}
  .card{
    position:relative;
    background: var(--card-bg);
    border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.06);
    box-shadow: 0 10px 28px rgba(12,18,30,0.06);
    display:flex;flex-direction:column;min-height:140px;transition:transform .18s ease, box-shadow .18s;
    backdrop-filter: blur(calc(var(--glass-blur) - 6px)) saturate(var(--glass-sat));
  }
  .card::before{
    content:"";
    position:absolute;left:0;right:0;top:0;height:36%;
    border-radius:12px 12px 0 0;
    background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.02));
    mix-blend-mode: overlay;
    pointer-events:none;
  }
  .meta{display:flex;align-items:center;gap:12px}
  .tag{padding:6px 8px;border-radius:8px;font-weight:700;color:var(--accent);font-size:13px;border:1px solid rgba(0,0,0,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.02))}
  .name{font-weight:700;margin:0;font-size:15px}
  .desc{color:var(--muted);font-size:13px;margin:8px 0 0}
  .foot{display:flex;align-items:center;margin-top:auto;gap:10px}
  .pill{font-family:var(--mono);background:rgba(255,255,255,0.06);padding:6px 8px;border-radius:8px;font-size:12px;color:#333}
  .small{color:var(--muted);font-size:13px}
  .card .actions{margin-left:auto;display:flex;gap:8px}
  .count{font-size:12px;color:var(--muted)}

  /* modal */
  .modal-wrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(6,12,20,0.45);z-index:1500}
  .modal{width:92%;max-width:980px;border-radius:12px;padding:14px;background:rgba(255,255,255,0.9);color:#0b1220;box-shadow:0 30px 60px rgba(2,6,23,0.45)}
  pre{background:rgba(246,248,251,0.6);padding:12px;border-radius:8px;overflow:auto;font-family:var(--mono);font-size:13px;max-height:62vh}
  .close{margin-left:auto;background:transparent;border:1px solid rgba(12,18,30,0.06);padding:8px;border-radius:8px;cursor:pointer}

  .copy-toast{position:fixed;right:22px;bottom:22px;background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.18);display:none}

  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}

  /* 管理面板 */
  .admin-panel{position:fixed;right:20px;top:90px;width:360px;background:rgba(255,255,255,0.9);border-radius:12px;padding:12px;box-shadow:0 18px 40px rgba(12,18,30,0.12);z-index:1600;display:none}
  .admin-panel h3{margin:0 0 8px 0;font-size:15px}
  .admin-row{display:flex;gap:8px;margin-bottom:8px}
  .admin-row input[type="text"], .admin-row select, .admin-row textarea{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(10,14,20,0.06);background:rgba(255,255,255,0.86)}
  .admin-list{max-height:240px;overflow:auto;border-top:1px dashed rgba(0,0,0,0.04);padding-top:8px;margin-top:8px}
  .admin-item{display:flex;justify-content:space-between;gap:8px;padding:6px;border-radius:8px}
  .danger{background:#fff1f0;border-color:#ffb4b4;color:#bf2600}
  .muted-note{font-size:12px;color:var(--muted);margin-top:6px}

  /* 微交互 */
  .theme-option:hover, .admin-item:hover{transform:translateY(-4px);transition:transform .14s}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">Py</div>
      <div class="title">
        <h1>Python 分发站 · 专业下载</h1>
        <p>融合 Windows7 手感、Apple 质感与开发者友好，单文件静态页面分发脚本/安装包。</p>
      </div>

      <div class="tools" role="toolbar" aria-label="site tools">
        <button class="btn primary" id="downloadAllBtn">下载全部 (zip)</button>
        <button class="btn" id="refreshBtn">刷新</button>
        <button class="btn ghost" id="readmeBtn">说明</button>

        <!-- 主题菜单（单按钮） -->
        <div class="theme-menu" id="themeMenu">
          <button class="theme-toggle" id="themeToggle">主题 ▾</button>
          <div class="theme-panel" id="themePanel" role="menu" aria-hidden="true">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">选择主题颜色</div>
              <div class="small-note">预览并应用</div>
            </div>

            <div class="theme-option" data-theme="orange" role="menuitem" tabindex="0">
              <div class="swatch" style="background:linear-gradient(135deg,#f57c00,#ffb300)"></div>
              <div class="theme-label">橙色（默认）</div>
            </div>

            <div class="theme-option" data-theme="blue" role="menuitem" tabindex="0">
              <div class="swatch" style="background:linear-gradient(135deg,#1976d2,#64b5f6)"></div>
              <div class="theme-label">蓝色</div>
            </div>

            <div class="theme-option" data-theme="green" role="menuitem" tabindex="0">
              <div class="swatch" style="background:linear-gradient(135deg,#2e7d32,#66bb6a)"></div>
              <div class="theme-label">绿色</div>
            </div>

            <div class="theme-option" data-theme="purple" role="menuitem" tabindex="0">
              <div class="swatch" style="background:linear-gradient(135deg,#8e24aa,#b39ddb)"></div>
              <div class="theme-label">紫色</div>
            </div>

            <div class="theme-controls-row" style="margin-top:6px">
              <div class="glass-switch">
                <label><input type="checkbox" id="glassToggle"> 透明玻璃</label>
              </div>
              <div style="display:flex;gap:6px">
                <button class="btn" id="themeReset">重置</button>
              </div>
            </div>

            <div class="small-note">提示：玻璃效果使用浏览器 backdrop-filter，部分旧浏览器可能不完全支持。</div>
          </div>
        </div>

        <button class="btn ghost" id="adminBtn" title="管理员登录">管理员</button>
      </div>
    </header>

    <div class="controls">
      <div class="search">
        <input type="search" id="search" placeholder="搜索文件名、描述或平台（回车搜索）" />
      </div>
      <select id="filter">
        <option value="all">全部类型</option>
        <option value="script">脚本 (.py)</option>
        <option value="binary">二进制/安装包</option>
      </select>
      <select id="sort">
        <option value="name">按名称</option>
        <option value="size">按大小</option>
        <option value="downloads">按下载量</option>
      </select>
    </div>

    <main class="grid" id="grid" aria-live="polite"></main>

    <footer>将此文件放到静态主机或 GitHub Pages。若需要真实二进制分发，请替换文件 url 指向实际文件。</footer>
  </div>

  <!-- modal preview -->
  <div class="modal-wrap" id="modal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modTitle">
      <div class="meta" style="display:flex;align-items:center;gap:12px">
        <div>
          <strong id="modTitle">预览</strong>
          <span id="modName" class="pill" style="margin-left:8px"></span>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn" id="modDownload">下载</button>
          <button class="btn" id="modCopy">复制</button>
          <button class="close" id="modClose">关闭</button>
        </div>
      </div>
      <pre id="modContent" tabindex="0"></pre>
    </div>
  </div>

  <div class="copy-toast" id="toast">已复制到剪贴板</div>

  <!-- 管理面板（客户端实现）-->
  <div class="admin-panel" id="adminPanel" aria-hidden="true">
    <h3>管理员面板</h3>
    <div class="admin-row">
      <input type="text" id="a_name" placeholder="文件名（含扩展名）" />
    </div>
    <div class="admin-row">
      <select id="a_type">
        <option value="script">script</option>
        <option value="binary">binary</option>
      </select>
      <input type="text" id="a_platform" placeholder="平台（如 Windows/Linux）" />
    </div>
    <div class="admin-row">
      <input type="text" id="a_desc" placeholder="描述" />
    </div>
    <div class="admin-row">
      <input type="file" id="a_file" />
    </div>
    <div class="admin-row">
      <textarea id="a_content" placeholder="或直接粘贴源代码 / 内容" rows="6"></textarea>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn primary" id="a_save">保存并上架</button>
      <button class="btn" id="a_import">导出上传(zip)</button>
      <button class="btn ghost" id="a_close">关闭</button>
    </div>
    <div class="muted-note">说明：管理员密码在客户端验证（不安全）。上传内容保存在本地浏览器 localStorage，仅在该浏览器可见。如需公开永久保存，请接入服务器或 GitHub API。</div>
    <div class="admin-list" id="adminList"></div>
  </div>

<script>
/* ---------------------- 数据与持久化 ---------------------- */
const DEFAULT_FILES = [
  {
    name: "绿梵AI.py",
    type: "script",
    platform: "Windows/Linux/macOS",
    desc: "tkinter + selenium 自动化聊天脚本（含 webdriver 管理示例）。",
    content: `# 省略... 保持原始脚本内容在示例中`
  },
  {
    name: "非爬取方式.py",
    type: "script",
    platform: "Cross-platform",
    desc: "轻量的关键字匹配本地问答脚本，适合离线测试与示例。",
    content: `# 省略... 保持原始脚本内容在示例中`
  }
];

function loadUserFiles(){
  try{
    const raw = localStorage.getItem('user_files');
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(Array.isArray(arr)) return arr;
  }catch(e){}
  return [];
}
function saveUserFiles(list){
  try{
    localStorage.setItem('user_files', JSON.stringify(list));
    return true;
  }catch(e){ return false; }
}

let FILES = [];
function initFiles(){
  const users = loadUserFiles();
  const map = {};
  DEFAULT_FILES.concat(users).forEach(f=> map[f.name] = f);
  FILES = Object.values(map);
}

/* ---------------------- 工具 ---------------------- */
const $ = s => document.querySelector(s);
const g = id => document.getElementById(id);
async function sha1Hex(str){
  const buf = new TextEncoder().encode(str || '');
  const hash = await crypto.subtle.digest('SHA-1', buf);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
}
function getCounts(){ try{ return JSON.parse(localStorage.getItem('dl_counts')||'{}') }catch{ return {} } }
function incCount(name){ const c=getCounts(); c[name]=(c[name]||0)+1; localStorage.setItem('dl_counts',JSON.stringify(c)); }

/* ---------------------- 渲染 ---------------------- */
function makeCard(f, idx){
  const div = document.createElement('article');
  div.className='card';
  div.innerHTML = `
    <div class="meta">
      <div class="tag">${(f.type||'file').toUpperCase()}</div>
      <div style="flex:1">
        <p class="name">${escapeHtml(f.name)}</p>
        <div class="desc">${escapeHtml(f.desc||'')}</div>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <span class="pill">${escapeHtml(f.platform||'Unknown')}</span>
          <span class="small" id="size-${idx}">计算大小…</span>
          <span class="count" id="count-${idx}"></span>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" data-download="${idx}">下载</button>
        <button class="btn" data-view="${idx}">预览</button>
      </div>
    </div>
  `;
  const sizeEl = div.querySelector(`#size-${idx}`);
  const countEl = div.querySelector(`#count-${idx}`);
  const blob = new Blob([f.content || ''], {type:'application/octet-stream'});
  sizeEl.textContent = blob.size < 1024 ? `${blob.size} B` : `${(blob.size/1024).toFixed(1)} KB`;
  const counts = getCounts(); countEl.textContent = `下载 ${counts[f.name]||0} 次`;
  div.querySelector('[data-download]').onclick = ()=>downloadFile(idx);
  div.querySelector('[data-view]').onclick = ()=>openModal(idx);
  return div;
}
function render(list){
  const grid = g('grid');
  grid.innerHTML = '';
  list.forEach((f,i)=> grid.appendChild(makeCard(f,i)));
}
function applyFilters(){
  const q = g('search').value.trim().toLowerCase();
  const filter = g('filter').value;
  const sort = g('sort').value;
  let list = FILES.filter(f=>{
    if(filter!=='all' && f.type!==filter) return false;
    if(!q) return true;
    return (f.name+ (f.desc||'') + (f.platform||'')).toLowerCase().includes(q);
  });
  if(sort==='name') list.sort((a,b)=>a.name.localeCompare(b.name));
  else if(sort==='size') list.sort((a,b)=> (new Blob([a.content||'']).size) - (new Blob([b.content||'']).size) );
  else if(sort==='downloads'){
    const counts = getCounts();
    list.sort((a,b)=>(counts[b.name]||0)-(counts[a.name]||0));
  }
  render(list);
}

/* ---------------------- 下载 / 预览 ---------------------- */
async function downloadFile(i){
  const f = FILES[i];
  incCount(f.name);
  applyFilters();
  if(f.url){
    const a = document.createElement('a'); a.href = f.url; a.download = f.name; document.body.appendChild(a); a.click(); a.remove();
    return;
  }
  if(typeof f.content === 'string' && f.content.startsWith('__base64__:')){
    const b64 = f.content.slice('__base64__:'.length);
    const byteChars = atob(b64);
    const byteNumbers = new Array(byteChars.length);
    for (let j = 0; j < byteChars.length; j++) byteNumbers[j] = byteChars.charCodeAt(j);
    const byteArray = new Uint8Array(byteNumbers);
    const blob = new Blob([byteArray], {type: 'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = f.name; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),5000);
    return;
  }
  const blob = new Blob([f.content || ''], {type: f.type==='script' ? 'text/x-python;charset=utf-8' : 'application/octet-stream'});
  sha1Hex(f.content || '').then(h=> console.log(`${f.name} SHA1: ${h}`)).catch(()=>{});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = f.name; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),5000);
}

function openModal(i){
  const f = FILES[i];
  g('modName').textContent = f.name;
  g('modTitle').textContent = `${(f.type||'file').toUpperCase()} 预览`;
  g('modContent').textContent = f.content || '(无内容)';
  g('modal').style.display = 'flex';
  g('modDownload').onclick = ()=>downloadFile(i);
  g('modCopy').onclick = ()=>{ navigator.clipboard.writeText(f.content || '').then(()=>showToast()) };
}
g('modClose').onclick = ()=> g('modal').style.display='none';
function downloadAll(){
  const zip = new JSZip();
  FILES.forEach(f=> zip.file(f.name, f.content || ''));
  zip.generateAsync({type:'blob', compression:'DEFLATE'}).then(blob=>{
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'python-files.zip'; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),5000);
  });
}
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }
function showToast(){ const t=g('toast'); t.style.display='block'; setTimeout(()=>t.style.display='none',1400) }

/* ---------------------- 事件绑定 ---------------------- */
g('search').addEventListener('keydown', e=>{ if(e.key==='Enter') applyFilters(); });
g('filter').addEventListener('change', applyFilters);
g('sort').addEventListener('change', applyFilters);
g('downloadAllBtn').addEventListener('click', downloadAll);
g('refreshBtn').addEventListener('click', ()=> location.reload());
g('readmeBtn').addEventListener('click', ()=> {
  g('modName').textContent='说明';
  g('modTitle').textContent='站点说明';
  g('modContent').textContent = `说明：
- 点击“下载”会把内置内容另存为文件。
- 管理功能为客户端实现：输入管理员密码后可上传文件并保存在浏览器 localStorage（只在该浏览器可见）。
- 若需“永远”保存到服务器或 GitHub，需要服务器端或 GitHub API 授权。`;
  g('modal').style.display='flex';
  g('modDownload').onclick = ()=>{};
  g('modCopy').onclick = ()=>{ navigator.clipboard.writeText(g('modContent').textContent).then(()=>showToast()) };
});
document.addEventListener('keydown', e=>{ if(e.key==='Escape') g('modal').style.display='none' });

/* ---------------------- 主题逻辑（菜单） ---------------------- */
const THEMES = {
  orange: {accent:'#f57c00', accent2:'#ffb300'},
  blue:   {accent:'#1976d2', accent2:'#64b5f6'},
  green:  {accent:'#2e7d32', accent2:'#66bb6a'},
  purple: {accent:'#8e24aa', accent2:'#b39ddb'}
};
function applyTheme(name){
  const t = THEMES[name];
  if(!t) return;
  document.documentElement.style.setProperty('--accent', t.accent);
  document.documentElement.style.setProperty('--accent-2', t.accent2);
  // update logo gradient
  $('.logo').style.background = `linear-gradient(135deg, ${t.accent}, ${t.accent2})`;
  localStorage.setItem('site_theme', name);
}
function restoreTheme(){
  const name = localStorage.getItem('site_theme') || 'orange';
  applyTheme(name);
}
g('themeToggle').addEventListener('click', ()=>{
  const p = g('themePanel');
  p.classList.toggle('show');
  p.setAttribute('aria-hidden', p.classList.contains('show') ? 'false':'true');
});
document.addEventListener('click', e=>{
  const panel = g('themePanel'), toggle = g('themeToggle');
  if(!panel) return;
  if(panel.classList.contains('show') && !panel.contains(e.target) && e.target !== toggle){
    panel.classList.remove('show'); panel.setAttribute('aria-hidden','true');
  }
});
document.querySelectorAll('.theme-option').forEach(el=>{
  el.addEventListener('click', ()=> applyTheme(el.getAttribute('data-theme')));
  el.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); el.click(); }});
});
g('glassToggle').addEventListener('change', ()=>{
  const on = g('glassToggle').checked;
  if(on){
    document.documentElement.style.setProperty('--panel-bg','rgba(255,255,255,0.18)');
    document.documentElement.style.setProperty('--card-bg','rgba(255,255,255,0.12)');
    document.body.classList.add('glass-mode');
    localStorage.setItem('glass_mode','1');
  } else {
    document.documentElement.style.setProperty('--panel-bg','rgba(255,255,255,0.55)');
    document.documentElement.style.setProperty('--card-bg','rgba(255,255,255,0.6)');
    document.body.classList.remove('glass-mode');
    localStorage.setItem('glass_mode','0');
  }
});
g('themeReset').addEventListener('click', ()=>{
  localStorage.removeItem('site_theme'); localStorage.removeItem('glass_mode');
  restoreTheme();
  g('glassToggle').checked = false;
});

/* ---------------------- 管理（客户端） ---------------------- */
/* 警告：客户端密码验证不安全，仅用于演示 */
const ADMIN_PASSWORD = 'lhm0627*';
function showPasswordPrompt(){
  const pwd = prompt('请输入管理员密码：');
  if(pwd === null) return;
  if(pwd === ADMIN_PASSWORD){
    sessionStorage.setItem('admin_auth','1');
    openAdminPanel();
  }else{
    alert('密码错误');
  }
}
g('adminBtn').addEventListener('click', showPasswordPrompt);
function openAdminPanel(){
  if(sessionStorage.getItem('admin_auth') !== '1'){ showPasswordPrompt(); return; }
  const panel = g('adminPanel'); panel.style.display='block'; panel.setAttribute('aria-hidden','false');
  refreshAdminList();
}
g('a_close').addEventListener('click', ()=>{ g('adminPanel').style.display='none'; g('adminPanel').setAttribute('aria-hidden','true'); });

g('a_file').addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const isText = f.type.startsWith('text') || /\.(py|txt|md|json|js|html|css)$/i.test(f.name);
  if(isText){
    const txt = await f.text();
    g('a_content').value = txt;
    g('a_name').value = f.name;
  }else{
    const reader = new FileReader();
    reader.onload = ()=> {
      g('a_content').value = `__base64__:${reader.result.split(',')[1]}`;
      g('a_name').value = f.name;
      g('a_type').value = 'binary';
    };
    reader.readAsDataURL(f);
  }
});

g('a_save').addEventListener('click', ()=>{
  const name = g('a_name').value.trim();
  const type = g('a_type').value;
  const platform = g('a_platform').value.trim() || 'Unknown';
  const desc = g('a_desc').value.trim() || '';
  const content = g('a_content').value || '';
  if(!name){ alert('请填写文件名'); return; }
  const users = loadUserFiles();
  const idx = users.findIndex(u=>u.name === name);
  const item = { name, type, platform, desc, content };
  if(idx>=0) users[idx] = item; else users.push(item);
  if(saveUserFiles(users)){
    alert('保存成功（保存在浏览器 localStorage）');
    initFiles(); applyFilters(); refreshAdminList();
    g('a_name').value=''; g('a_desc').value=''; g('a_content').value=''; g('a_file').value='';
  }else{
    alert('保存失败（localStorage 写入错误）');
  }
});

g('a_import').addEventListener('click', async ()=>{
  const users = loadUserFiles();
  if(!users.length){ alert('没有用户上传内容'); return; }
  const zip = new JSZip();
  users.forEach(u=>{
    if(typeof u.content === 'string' && u.content.startsWith('__base64__:')){
      const b64 = u.content.slice('__base64__:'.length);
      const byteChars = atob(b64);
      const byteNumbers = new Array(byteChars.length);
      for (let i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
      const byteArray = new Uint8Array(byteNumbers);
      zip.file(u.name, byteArray);
    }else{
      zip.file(u.name, u.content || '');
    }
  });
  const blob = await zip.generateAsync({type:'blob', compression:'DEFLATE'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'user-uploads.zip'; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),5000);
});

function refreshAdminList(){
  const list = g('adminList'); const users = loadUserFiles();
  list.innerHTML = '';
  if(users.length === 0){ list.innerHTML = '<div class="muted-note">暂无用户上传文件</div>'; return; }
  users.forEach((u,i)=>{
    const div = document.createElement('div'); div.className='admin-item';
    div.innerHTML = `<div style="flex:1"><strong>${escapeHtml(u.name)}</strong><div style="font-size:12px;color:var(--muted)">${escapeHtml(u.desc||'')}</div></div>
      <div style="display:flex;gap:6px">
        <button class="btn" data-load="${i}">加载</button>
        <button class="btn danger" data-del="${i}">删除</button>
      </div>`;
    list.appendChild(div);
    div.querySelector('[data-load]').onclick = ()=> {
      g('a_name').value = u.name; g('a_type').value = u.type; g('a_platform').value = u.platform; g('a_desc').value = u.desc; g('a_content').value = u.content || '';
    };
    div.querySelector('[data-del]').onclick = ()=> {
      if(!confirm('确认删除此用户上传并从 localStorage 中移除？')) return;
      users.splice(i,1); saveUserFiles(users); initFiles(); applyFilters(); refreshAdminList();
    };
  });
}

/* ---------------------- 初始化 ---------------------- */
initFiles();
applyFilters();
FILES.forEach(f=> sha1Hex(f.content || '').then(h=> console.debug(`${f.name} SHA1: ${h}`)).catch(()=>{}));
restoreTheme();
if(localStorage.getItem('glass_mode') === '1'){ g('glassToggle').checked = true; g('glassToggle').dispatchEvent(new Event('change')); }

/* small UX: hide theme panel on ESC */
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ const p = g('themePanel'); if(p && p.classList.contains('show')) { p.classList.remove('show'); p.setAttribute('aria-hidden','true'); } } });
</script>
</body>
</html>
